{% extends 'base/basic.html' %}
{% load static %}

{% block principal_part %}
    <div class="principal_block" id="Youtube">
        <div class="checking_link">
            <x-field>
                <input class='link_input' type="text" placeholder="Введите ссылку"
                       value="https://youtu.be/h8YOaGjLJQQ">
                <span class="close_span">
            &times;
            </span>
            </x-field>
        </div>
        <div class="browse_link"></div>
        <div class="download_links">
            <div class="download_objects_button">
                <div class="download_objects_button_inner download_objects_button_info">Классное видео</div>
                <div class="download_links_separator"></div>
                <div class="download_objects_button_inner download_objects_button_icon">В)</div>
                <div class="download_links_separator"></div>
                <div class="download_objects_button_inner download_objects_button_a">Сохранить</div>
            </div>

            <div class="download_objects_button">
                <div class="download_objects_button_inner download_objects_button_info">Классное видео</div>
                <div class="download_links_separator"></div>
                <div class="download_objects_button_inner download_objects_button_icon">В)</div>
                <div class="download_links_separator"></div>
                <div class="download_objects_button_inner download_objects_button_a">Сохранить</div>
            </div>

            <div class="download_objects_button">
                <div class="download_objects_button_inner download_objects_button_info">Классное видео</div>
                <div class="download_links_separator"></div>
                <div class="download_objects_button_inner download_objects_button_icon">В)</div>
                <div class="download_links_separator"></div>
                <div class="download_objects_button_inner download_objects_button_a">Сохранить</div>
            </div>

        </div>
        <div class="info_link">
            <video id='current_video_streams' autoplay="autoplay" width="400" height="300"
                   controls="controls" poster="video/duel.jpg">
                <source src="" type='video/mp4; codecs="avc1.42E01E, mp4a.40.2"'>
                Тег video не поддерживается вашим браузером.
            </video>
            <div class="info_link_data">
                <div class="data_item_title">Разрешение —
                    <div class="data_item" id="resolution"></div>
                </div>
                <div class="data_item_title">Видео-кодек —
                    <div class="data_item" id="video_codec"></div>
                </div>
                <div class="data_item_title">Аудио-кодек —
                    <div class="data_item" id="audio_codec"></div>
                </div>
                <div class="data_item_title">Битрейт —
                    <div class="data_item" id="abr"></div>
                </div>
                <div class="data_item_title">Размер —
                    <div class="data_item" id="filesize"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="principal_block_down" id="VK">
        VK
    </div>
    <div class="principal_block_down" id="Soundcloud">
        Soundcloud
    </div>
    <div class="principal_block_down" id="Facebook">
        Facebook
    </div>

{% endblock %}

{% block js %}
    <script type="text/javascript" src={% static "base/js/animation.js" %}></script>
{% endblock %}

{% block js_code %}
    <script>
        $(document).ready(function (urll, title) {

            function formatBytes(bytes, decimals = 2) {
                if (bytes === 0) return '0 Байт';

                const k = 1024;
                const dm = decimals < 0 ? 0 : decimals;
                const sizes = ['Байт', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];

                const i = Math.floor(Math.log(bytes) / Math.log(k));

                return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
            }

            $('.browse_link').html('<img class="status_gif" src="/static/base/icons/await.gif">')
            $('.link_input').on('input', function () {
                $('.browse_link').html('<img class="status_gif" src="https://c.tenor.com/I6kN-6X7nhAAAAAi/loading-buffering.gif">');
                $('.status_gif').hide();
                $('.status_gif').fadeIn(500);
                let $this = $(this),
                    val = $this.val();
                if (val.length === 0) {
                    $('.browse_link').html('<img class="status_gif" src="/static/base/icons/await.gif">')
                    $('.status_gif').hide();
                    $('.status_gif').fadeIn(500);
                    return false
                }
                $.ajax({
                    type: "post",
                    dataType: 'json',
                    data: {
                        'url': val,
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    },
                    url: '../' + "ajax_validate_url/",
                    // on success
                    success: function (response) {
                        if (response.streams[response.streams.length - 1] === true) {
                            let streams = response.streams[0];
                            $('.browse_link').html('<img class="big_status_gif" src="/static/base/icons/ok.gif">')
                            let bsg = $('.big_status_gif')
                            let ild = $('.info_link_data')
                            bsg.hide();
                            bsg.fadeIn(500);
                            console.log(response.streams)
                            $('#current_video_streams').attr('src', response.streams[0][response.streams[0].length - 1]['url']);
                            ild.find('#resolution').html('&nbsp' + response.streams[0][response.streams[0].length - 1]['resolution']);
                            ild.find('#video_codec').html('&nbsp' + response.streams[0][response.streams[0].length - 1]['video_codec']);
                            ild.find('#audio_codec').html('&nbsp' + response.streams[0][response.streams[0].length - 1]['audio_codec']);
                            ild.find('#abr').html('&nbsp' + response.streams[0][response.streams[0].length - 1]['abr']);
                            ild.find('#filesize').html('&nbsp' + formatBytes(response.streams[0][response.streams[0].length - 1]['filesize']));

                            streams.forEach(function (entry) {
                                $('.download_links').append(`
                                <div class="download_objects_button">
                                    <div class="download_objects_button_inner download_objects_button_info">Классное видео</div>
                                    <div class="download_links_separator"></div>
                                    <div class="download_objects_button_inner download_objects_button_icon">В)</div>
                                    <div class="download_links_separator"></div>
                                    <div class="download_objects_button_inner download_objects_button_a"><a class="download_link" href="` + {% url 'download' %} + '?exp=' + entry['subtype'] + '&link=' + entry['url'].replaceAll('&', 'mozzarella') + `">Скачать</a></div>
                                </div>
                                `)

                                $(".download_links").append('<div class="download_block"></div>');
                            });
                        } else {
                            $('.browse_link').html('<img class="big_status_gif" src="/static/base/icons/cross.gif">')
                            $('.big_status_gif').hide();
                            $('.big_status_gif').fadeIn(500);
                            $('.info_link').text(response.streams)
                        }

                    },
                    error: function (response) {
                        $('.browse_link').html('<img class="big_status_gif" src="/static/base/icons/cross.gif">')
                        $('.big_status_gif').hide();
                        $('.big_status_gif').fadeIn(500);
                    }
                });
                return false;
            });
        })
    </script>
{% endblock %}